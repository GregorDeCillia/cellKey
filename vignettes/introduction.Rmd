---
title: "Introduction to the cellKey-Package"
author: "Bernhard Meindl"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
  toc: true
toc_depth: 5
number_sections: false
vignette: >
  %\VignetteIndexEntry{Introduction to the cellKey-Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

  ```{r, echo=FALSE}
library(rmarkdown)
```

# Introduction

This package implements methods to provide perturbation for statistical tables. The method implemented in this package is largely based on the paper *Methodology for the Automatic Confidentialisation of Statistical Outputs from Remote Servers at the Australian Bureau of Statistics* (Thompson, Broadfoot, Elazar). This approach however was generalized and a new specification on how record keys are specified and the lookup-tables are defined is used. This package makes usage of perturbation tables that can be defined in the [**ptable**](https://github.com/sdcTools/ptable) package.

## Main Features
In the **cellKey** package it is possible to pertub multidimensional count and magnitude tables. Functionality to generate suitable record keys is provided in function `ck_generate_rkeys()`. Using sha1-checksums on the input datasets, we can make sure that the same record keys are generated whenever the same input data set is used for which record keys should be generated. However, it is also possible of course to use already pre-generated record keys available as variable in the microdata set.

The package allows to make use of sampling weights. Thus, both weighted and unweighted count and magnitude tables can be perturbed. The hierarchical structure of the variables spanning the table can be arbitrarily complex. To generate these hierarchies, the **cellKey** packages depends on functionality available in package [**sdcHierarchies**](https://cran.r-project.org/package=sdcHierarchies). Finally, auxiliary methods are provided that allow to extract valueable information from objects created by the main function of this package `perturbTable()`. For example `mod_counts()` returns a data object showing for each cell the perturbation value and where it was found in the lookup table.

What is left is of course identifying bugs and issues and also to optimize performance of the package as well as to include some real world examples, eg. census tables.

## An Example
We now show the capabilities of the **cellKey** package by running an example that 

### Load the Package
```{r}
library(cellKey)
packageVersion("cellKey")
```


The first step in this approach is to generate a statistical table, which can be achieved using `ck_setup`. This function generates an object that contains all the information required to perturb count- (and optionally continuously scaled) variables. There are however a few inputs that `ck_setup()` requires and that need to be generated beforehand. These inputs are:

- `x`: a `data.frame` or `data.table` containing microdata
- `rkey`: defines where to find or how to compute record keys. It is possible to either specify a scalar character name or a number. If a number is specified, record keys are internally created by sampling from a uniform distribution between 0 and 1 with the random numbers rounded to the specified value of digits. If a name is specified, this name is interpreted as a variable name within `x` already containing record keys.
- `dims`: a named list where each list element contains a hierarchy created with functionality from package [**sdcHierarchies**](ttps://cran.r-project.org/package=sdcHierarchies) and each name refers to a variable in `x`
- `w`: either `NULL` (no weights) or the name of a variable in `x` that contains weights
- `countvars`: an optional character vector of variables in `x` holding counts. In any case a special count variable `total` is internally generated that is `1` for each row of `x`
- `numvars`: an optional character vector of variables in `x` holding numerical variables that can later be perturbed.
- `params_cnts`: an object containing perturbation parameters relevant to `countvars` that needs to be created using `ck_params_cnts()`.
- `params_nums`: if `numvars` was specified, an object containing perturbation parameters relevant to `numvars` that must to be created using `ck_params_nums()`.

We now show how to generate the required inputs. The first step is to prepare the inputdata.


### Specifying inputdata
The testdata set we are using in this example contains information on person-level along with sampling weights as well as some categorical and continuously scaled variables. We also compute some binary variables for which we also want to create perturbed tables. 
```{r}
dat <- ck_create_testdata()
dat <- dat[, c("sex", "age", "savings", "income", "sampling_weight")]
dat[, cnt_males := ifelse(sex == "male", 1, 0)]
dat[, cnt_highincome := ifelse(income >= 9000, 1, 0)]
```

We are now adding record keys with 7 digits to the data set that are going to be used later using function `ck_generate_rkeys` as shown below:

```{r}
dat$rkeys <- ck_generate_rkeys(dat = dat, nr_digits = 7)
print(head(dat))
```

To ensure that the same record keys are computed each and every time for the same data set, a seed based on the sha1-hash of the input dataset is computed and used before drawing the record keys.

The goal of this introduction is to create a perturbed table of counts of variables `sex` by `age` for all observations as well as for the subgroups in `cnt_males` and `cnt_highincome` that are non-zero. We also want to create perturbed tables of continously scaled variables `savings` and `income` also giving the hierarchical structure defined by `sex` by `age`.

### Specifying dimensions
It is required to define hierarchies for each of the classifying variables of the desired table. There are two ways how the hierarchical structure of these variables (including sub-totals) can be specified. One way is to use `"@; value` format as (also) used in [**sdcTable**](ttps://cran.r-project.org/package=sdcTable). We would suggest however, to use the second alternative which is using functionality from package [**sdcHierarchies**](ttps://cran.r-project.org/package=sdcHierarchies). In this vignette, we only show the preferred way to generate hierarchies for categorical variables `age` and `sex` below:

```{r}
dim_sex <- hier_create(root = "Total", nodes = c("male", "female"))
hier_display(dim_sex)
```

For variable `age` the process is very much the same:
```{r}
dim_age <- hier_create(root = "Total", nodes = paste0("age_group", 1:6))
hier_display(dim_age)
```

The idea of [**sdcHierarchy**](https://github.com/bernhard-da/sdcHierarchies) is to create a tree object using `hier_create()` and then add (using `hier_add()`), delete (with `hier_delete()`) or rename (using `hier_rename()`) elements from this hierarchical structure. For more examples have a look at the package vignette of the package which can be accessed with `sdcHierarchies::hier_vignette()`. [**sdcHierarchy**](https://github.com/bernhard-da/sdcHierarchies) also contains a shiny-based app that can be called with `hier_app()` which allows to interactively change and modify a hierarchy and allows to convert tree- and data.frame based inputs into various formats. For more information, have a look at `?hier_app` and the other help-files of the package.

After all dimensions have been specified, these inputs must then be combined into a named list. In this object, the list-names refer to variable names of the input data set and the elements the data objects that hold the hierarchy specification itself. This is why the list elements of `dims` in this example have to be named `sex` and `age` as the specification refers to variables `age` and `sex` in input set `dat`.

```{r}
dims <- list(sex = dim_sex, age = dim_age)
print(dims)
```


### Define perturbation parameters for count variables
The next task is to define parameters that are used to perturb count variables which can be archieved using function `ck_params_cnts`. This function wraps `pt_create_pTable` from the [**ptable**](https://github.com/sdcTools/ptable) package, so for the parameters have a look at the help page for this function. A typical application is shown below:

```{r}
params_cnts <- ck_params_cnts(
  D = 5,
  V = 3,
  js = 2,
  pstay = 0.5,
  optim = 1,
  mono = TRUE
)
```

The output of `ck_params_cnts` is an object that can be directly used in `ck_setup()` as we will see later.

### Define perturbation parameters for continuous variables
To be written


### Setup a table instance
We now have prepared the inputs and can define a generic statistical table using `ck_setup()` as shown below:

```{r}
tab <- ck_setup(
  x = dat,
  rkey = "rkeys",
  dims = dims,
  w = "sampling_weight",
  countvars = c("cnt_males", "cnt_highincome"),
  numvars = NULL,
  params_cnts = params_cnts,
  params_nums = NULL
)
```

`ck_setup()` returns a `R6` class object that contains not only the relevant data but also all available methods. Thus, it is not required to assign the results of such methods to new objects, instead, the object itself is automatically updated.

These objects also have a custom print method, showing some general information about the object:

```{r}
print(tab)
```

### Compute perturbed tables
It is now possible to finally perturbed variables using the `perturb()`-method. As `tab` - the object created with `ck_setup()` - already contains all possible data, the only required input is the name of a count- or numeric variable that should be perturbed.

- `v`: a character vector specifying one or more variables that should be perturbed.

```{r}
tab$perturb(v = "total")
```

After this call, object `tab` is updated and contains now also perturbed values for variable `total`. The actual results can then be extracted using the `freqtab()`-method as discussed in the next section.

### Modify perturbation parameters
Using methods `params_cnts()` and `params_nums()` it is possible to modify the current set perturbation parameters. This is useful if one wants to use different perturbation inputs for different variables. We now show how to replace the current perturbation input for count variables. The first step is to create a new object containing perturbation parameters using `ck_params_cnts()`.
```{r}
params_cnts2 <- ck_params_cnts(
  D = 8,
  V = 10,
  js = 4
)
```

Updating/replacing the perturbation parameters can then be achieved as shown below:

```{r}
tab$params_cnts(params_cnts2)
```

From now on, these parameters will be used to perturb any count variables.


```{r}
tab$perturb(v = "cnt_males")
```


### Extract perturbed tables
Applying the `freqtab()`-methods to one ore more already perturbed variables returns a `data.table` that contains for each table cell the unpertubed and perturbed (weighted and/or unweighted) counts. This function has the following arguments:

- `v`: one or more variable names of already perturbed count variables
- `type`: a scalar character defining what variables should be included in the result. Possible choices are `"both"` (the default), `"weighted"` and `"unweighted"` 
- `path`: if not `NULL`, a (relative or absolute) path to which the resulting output table should be written. A `csv` file will be generated and `.csv` will be appended to the value provided.

The method returns a `data.table` with all combinations of the dimensional variables in the first $n$ colums and after those, all (or some) of the following columns:

- `vname`: name of the perturbed variable (always included)
- `uwc`: unweighted counts (if `type` is `"both"` or `"unweighted"`)
- `wc`: weighted counts (if `type` is `"both"` or `"weighted"`)
- `puwc`: perturbed unweighted counts (if `type` is `"both"` or `"unweighted"`)
- `pwc`: perturbed weighted counts (if `type` is `"both"` or `"weighted"`)

```{r}
tab$freqtab(v = "total", type = "both")
```

To query only the weighted unperturbed and perturbed counts for `total` and `cnt_males`, one could use the following code:

```{r}
tab$freqtab(v = "total", type = "weighted")
```


### Computing utility measures for count variables
Method `measures()` allows to compute information loss measures for perturbed count variables. Its application is as simple as:

```{r}
tab$measures(v = "total")
```

This function returns a list several utility measures which are described in detail in `?ck_cnt_measures`.

### Perturbing numeric variables

The next example shows how to create a perturbed table of continuous data using sampling weights. We can perturb all variables that were specified in argument `numvars` when calling `ck_setup()`. Note that it is also possible to specify multiple variables at once.

```{r, eval = FALSE}
tab$perturb(v = "income")
```

To get information about magnitude tables, method `numtab()` can be used. In this case, we can set an additional argument `mean_before_sum` that is either `TRUE` or `FALSE` and specifies how the perturbed cell values are computed. Details on this method can be found in *Methodology for the Automatic Confidentialisation of Statistical Outputs from Remote Servers at the Australian Bureau of Statistics* (Thompson, Broadfoot, Elazar) in Section *6.3*. All other arguments are identical to method `freqtab()` that was previously introduced.

```{r, eval = FALSE}
p_income <- tab$numtab(v = "income", mean_before_sum = TRUE)
p_income
```


### Extract information from results
Some auxiliary methods may be applied to an object created with `ck_setup()`. For example one can query the applied perturbations for counts using the `mod_cnts()` method. This returns a `data.table` showing for each cell and tabulated variable the row and the column of the perturbation table that was used to find the perturbation value actually used. The value itself is also included.

```{r}
tab$mod_cnts()
```

Information on perturbations for numerical variables can be extracted using `mod_nums()`. This `data.table` contains the ids of the observations of the input variables that have been modified. For each observation and tabulated numerical variable (given in `numvars`), the parameters used in modifying (direction, magnitude and noise) are shown as well as the original values, the perturbation and the final modified value. These values were finally used to compute the tables itself.
```{r, echo = FALSE}
message("WRITE METHOD mod_nums()")
```

```{r, eval = FALSE}
tab$mod_nums()
```

Finally we note that there are `print` and `summary` methods implemented for objects created with from `ck_setup()` which can be used as shown below:

```{r}
print(tab)
#summary(tab)
```

## Summary
In case you have any suggestions or improvements, please feel free to file an issue at [**our issue tracker**](https://github.com/sdcTools/cellKey/issues) or contribute to the package by filing a [**pull request**](https://github.com/sdcTools/cellKey/pulls) against the master branch.
